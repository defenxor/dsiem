version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.11
        environment:
          GO111MODULE: "on"
          GOFLAGS: "-mod=vendor"
    working_directory: /go/src/github.com/defenxor/dsiem
    steps:
      - checkout
      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}
            - go-path-v1-{{ checksum "go.sum" }}
      - run:
          name: run build
          command: |
            ./scripts/gobuild-cmd.sh
      - run:
          name: run tests
          command: |
            go fmt ./...
            go vet ./...
            GOFLAGS=-mod= go get github.com/mattn/goveralls
            go test -v -cover -race -coverprofile=./coverage.out $(go list ./...)
            GOFLAGS=-mod= goveralls -coverprofile=./coverage.out -service=circle-ci -repotoken=$COVERALLS_TOKEN
      # goveralls will ignore vendor dir and download stuff, so we cache its results here
      - save_cache:
          key: go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - save_cache:
          key: go-path-v1-{{ checksum "go.sum" }}
          paths:
            - "/go/src"
  build-web:
    docker:
      - image: circleci/node:8.12-browsers
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-mod-v1-{{ checksum "web/ui/package.json" }}
      - run:
          name: install deps
          command: | 
            cd web/ui 
            npm install
      - save_cache:
          key: node-mod-v1-{{ checksum "web/ui/package.json" }}
          paths:
            - "web/ui/node_modules"
      # this will be enabled once the web UI code is ready for it
      # - run:
      #     name: Linting
      #     command: cd web/ui && npm run lint
      # - run:
      #     name: Testing
      #     command: cd web/ui && npm run test
      - run:
          name: build-dist
          command: |
            cd web/ui
            npm run ng -- build --prod --build-optimizer --base-href /ui/
            rm -rf ../dist
            cp -r ./dist ../
      - persist_to_workspace:
          root: .
          paths: web/dist/*
  release:
    docker:
      - image: circleci/golang:1.11
        environment:
          GO111MODULE: "on"
          GOFLAGS: "-mod=vendor"
    working_directory: /go/src/github.com/defenxor/dsiem
    steps:
      - checkout
      - add_ssh_keys
      - restore_cache:
          keys:
            - go-mod-deploy-v1-{{ checksum "go.sum" }}
            - go-path-deploy-v1-{{ checksum "go.sum" }}
      - run: GOFLAGS=-mod= go get -u github.com/tcnksm/ghr
      - run: GOFLAGS=-mod= go get -u github.com/stevenmatthewt/semantics
      - save_cache:
          key: go-mod-deploy-v1-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - save_cache:
          key: go-path-deploy-v1-{{ checksum "go.sum" }}
          paths:
            - "/go/src"
      - attach_workspace:
          at: .
      - run:
          name: create release
          command: |
            tag=$(semantics --output-tag)
            if [ "$tag" ]; then
              ./scripts/gobuild-cmd-release.sh $tag
              echo $tag > ./releaseflag
              ghr -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME -draft -replace $tag temp/release/$tag
              msg="{ \"text\" : \"Release draft $tag has been posted for review, approval within 30 minutes will also release a docker image.\" }"
              command -v curl >/dev/null 2>&1 && curl -X POST -H 'Content-type: application/json' -d "$msg" $SLACK_WEBHOOK || echo curl error occurred
            else
              echo "The commit message(s) did not indicate a major/minor/patch version."
              touch ./releaseflag
            fi
      - persist_to_workspace:
          root: .
          paths: releaseflag
  deploy-dockerhub:
    machine: true
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: create docker image
          command: |

            # make sure this wont return non-zero
            tag=$(cat ./releaseflag 2>/dev/null || echo)

            if [ "$tag" ]; then
              # get downloader for private asset
              wget https://github.com/gruntwork-io/fetch/releases/download/v0.3.2/fetch_linux_amd64 -O /tmp/fetch
              chmod +x /tmp/fetch
              # wait until the release is approved, exit after waiting for >= 30 minutes
              minutewait=30
              # fetch requires this
              export GITHUB_OAUTH_TOKEN=$GITHUB_TOKEN
              while ! /tmp/fetch --repo="https://github.com/defenxor/dsiem" --tag=$tag --release-asset="dsiem-server_linux_amd64.zip" /tmp 2>/dev/null; do
                [ "$minutewait" == "0" ] && echo "Timeout waiting for release asset, skipping docker build." && exit 0
                echo "release $tag doesnt exist yet, sleeping for 60 seconds before retrying .. retry left: $minutewait"
                minutewait=$(( minutewait - 1 ))
                sleep 60
              done
              echo "building docker for release $tag .."
              cd deployments/docker/build
              docker build -f Dockerfile -t defenxor/dsiem:$tag -t defenxor/dsiem:latest . --build-arg ver=$tag --build-arg token=$GITHUB_TOKEN
              echo "$DOCKER_PASSWD" | docker login -u $DOCKER_USER --password-stdin
              docker push defenxor/dsiem:$tag
              docker push defenxor/dsiem:latest
            else
              echo "Releaseflag is not set."
            fi
workflows:
  version: 2
  build-test-release:
    jobs:
      - build
      - build-web
      - release:
          requires:
            - build
            - build-web
          filters:
            branches:
              only: master
      - deploy-dockerhub:
          requires:
            - release
  build-test:
    jobs:
      - build:
          branches:
            ignore: master
      - build-web:
          branches:
            ignore: master
